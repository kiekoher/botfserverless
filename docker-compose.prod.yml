services:
  whatsapp-gateway:
    image: ${WHATSAPP_GATEWAY_IMAGE}
    container_name: eva_whatsapp_gateway_prod
    restart: unless-stopped
    mem_limit: 768m
    cpus: '0.75'
    environment:
      # Variables are injected by a secret manager like Doppler at runtime.
      # See DEPLOYMENT_GUIDE.md for more information on which variables to set.
      - MAIN_API_URL=${MAIN_API_URL}
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - WHATSAPP_USER_ID=${WHATSAPP_USER_ID}
    volumes:
      - whatsapp_session_prod:/app/session
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9100/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      # Forwards logs to a centralized syslog server (Better Stack).
      # Requires BETTERSTACK_INGEST_HOST and BETTERSTACK_SOURCE_TOKEN to be in the environment.
      driver: syslog
      options:
        syslog-address: "tcp://${BETTERSTACK_INGEST_HOST}:6514"
        syslog-format: "rfc5424"
        tag: '[logtail@11993 source_token="${BETTERSTACK_SOURCE_TOKEN}"] eva_whatsapp_gateway'

volumes:
  whatsapp_session_prod:
